<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DeynikGram | Discord</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #313338; --text: #dbdee1; --accent: #5865f2; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; }
        .msg { margin-bottom: 10px; padding: 5px; border-bottom: 1px solid #404249; }
        .u { color: #fff; font-weight: bold; margin-right: 10px; }
        .input-area { padding: 20px; background: #2b2d31; }
        input { width: 100%; padding: 10px; background: #383a40; border: none; color: #fff; border-radius: 5px; outline: none; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div class="input-area">
        <input type="text" id="msgInput" placeholder="Напиши и нажми Enter">
    </div>

<script>
    const URL = 'https://lxkoslrnzxiarvorhxbn.supabase.co';
    const KEY = 'sb_publishable_aEeKlRDjcF2a8WMMe6eRXQ_TjThIWa7';
    const supabaseClient = supabase.createClient(URL, KEY);

    let user = localStorage.getItem('user') || prompt("Твой ник:");
    if(!user) user = "Anon";
    localStorage.setItem('user', user);

    async function load() {
        const { data, error } = await supabaseClient.from('messages').select('*').order('id', { ascending: true });
        if (error) console.error("Ошибка загрузки:", error);
        if (data) data.forEach(m => addMsg(m));
    }

    function addMsg(m) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<span class="u">${m.username}:</span><span>${m.content}</span>`;
        const chat = document.getElementById('chat');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
        const input = document.getElementById('msgInput');
        const val = input.value.trim();
        if(!val) return;
        
        console.log("Пытаюсь отправить:", val);
        input.value = '';

        const { error } = await supabaseClient.from('messages').insert([{ username: user, content: val }]);
        
        if(error) {
            alert("ОШИБКА БАЗЫ: " + error.message);
            console.error(error);
        }
    }

    // Слушаем Enter
    document.getElementById('msgInput').addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            send();
        }
    });

    // Realtime
    supabaseClient.channel('messages').on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'messages' }, 
        payload => addMsg(payload.new)
    ).subscribe();

    load();
</script>
</body>
</html>
