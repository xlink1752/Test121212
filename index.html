<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeynikGram | Discord</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-main: #313338; --bg-sidebar: #2b2d31; --bg-input: #383a40; --text-main: #dbdee1; --text-muted: #949ba4; --accent: #5865f2; --white: #ffffff; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Roboto', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #1e1f22; }
        .server-name { padding: 15px; font-weight: bold; border-bottom: 1px solid #1e1f22; color: var(--white); font-size: 1.1rem; }
        .channel { margin: 10px; padding: 8px 10px; border-radius: 4px; background: #3f4147; color: var(--white); display: flex; align-items: center; font-weight: 500; }
        .channel::before { content: "# "; color: var(--text-muted); margin-right: 5px; font-size: 1.2rem; }
        .main { flex: 1; display: flex; flex-direction: column; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg-container { display: flex; margin-bottom: 12px; padding: 4px 10px; border-radius: 4px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; }
        .msg-content { display: flex; flex-direction: column; }
        .msg-header { display: flex; align-items: baseline; gap: 8px; }
        .username { color: var(--white); font-weight: 500; }
        .time { font-size: 0.7rem; color: var(--text-muted); }
        .text { color: var(--text-main); line-height: 1.375rem; margin-top: 2px; white-space: pre-wrap; word-break: break-word; }
        .input-area { padding: 0 20px 24px 20px; }
        .input-wrapper { background: var(--bg-input); border-radius: 8px; padding: 11px 15px; }
        input { background: transparent; border: none; color: var(--text-main); width: 100%; outline: none; font-size: 1rem; }
    </style>
</head>
<body>
<div class="sidebar"><div class="server-name">DEYNIKGRAM</div><div class="channel">основной-чат</div></div>
<div class="main">
    <div id="chat"></div>
    <div class="input-area"><div class="input-wrapper"><input type="text" id="message-input" placeholder="Написать в #основной-чат" autocomplete="off"></div></div>
</div>
<script>
    const URL = 'https://lxkoslrnzxiarvorhxbn.supabase.co'; 
    const KEY = 'sb_publishable_aEeKlRDjcF2a8WMMe6eRXQ_TjThIWa7'; 
    const supabaseClient = supabase.createClient(URL, KEY);
    
    let user = localStorage.getItem('user') || prompt("Твой ник:");
    if(!user) user = "Юзер" + Math.floor(Math.random()*100);
    localStorage.setItem('user', user);

    const chatDiv = document.getElementById('chat');

    async function load() {
        const { data, error } = await supabaseClient.from('messager').select('*').order('id', { ascending: true });
        if (data) data.forEach(m => render(m));
        scroll();
    }

    function render(m) {
        const time = new Date(m.created_at || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const html = `<div class="msg-container"><div class="avatar">${m.username[0].toUpperCase()}</div><div class="msg-content"><div class="msg-header"><span class="username">${m.username}</span><span class="time">${time}</span></div><div class="text">${m.content}</div></div></div>`;
        chatDiv.insertAdjacentHTML('beforeend', html);
        scroll();
    }

    async function send() {
        const i = document.getElementById('message-input');
        const val = i.value.trim();
        if(!val) return;
        i.value = '';
        const { error } = await supabaseClient.from('messager').insert([{ username: user, content: val }]);
        if(error) alert("Ошибка базы: " + error.message);
    }

    function scroll() { chatDiv.scrollTop = chatDiv.scrollHeight; }

    supabaseClient.channel('public:messager').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messager' }, payload => render(payload.new)).subscribe();

    document.getElementById('message-input').addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); send(); } });
    load();
</script>
</body>
</html>
